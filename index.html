<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intellimark.ai - Beta con Analisi AI</title>
    <!-- Versione 10.0 - Aggiunti filtri avanzati e giudizio AI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Aggiunta libreria per selettori avanzati -->
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --color-primary-start: #0A2A5B; --color-primary-end: #4A0E69; --color-green: #28A745; --color-yellow: #FFC107; --color-red: #DC3545; }
        body { font-family: 'Figtree', sans-serif; background-color: #F8F9FA; }
        .gradient-text { background: linear-gradient(to right, var(--color-primary-start), var(--color-primary-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-gradient { background: linear-gradient(to right, var(--color-primary-start), var(--color-primary-end)); }
        .hidden { display: none !important; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(248, 249, 250, 0.8); backdrop-filter: blur(5px); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .spinner { border: 6px solid #e2e8f0; border-top: 6px solid var(--color-primary-start); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Stile per i selettori Tom-Select */
        .ts-control { border-radius: 9999px !important; border: 2px solid transparent !important; padding: 0.8rem 1rem !important; }
        .ts-control:focus, .ts-wrapper.focus .ts-control { box-shadow: 0 0 0 2px #3b82f6 !important; border-color: transparent !important; }
    </style>
</head>
<body class="antialiased text-gray-800">
    <div id="loading-overlay" class="hidden"> <div class="text-center"> <div class="spinner mx-auto"></div> <p class="mt-4 text-lg font-semibold font-inter text-gray-700">Analisi in corso...</p> </div> </div>
    <div id="app-container">
        <header id="main-header" class="bg-white/80 backdrop-blur-sm sticky top-0 z-40 border-b border-gray-200/80">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="#" class="font-inter font-bold text-2xl gradient-text" onclick="location.reload(); return false;" aria-label="Homepage di Intellimark.ai"> Intellimark.ai </a>
            </div>
        </header>
        <main>
            <section id="home-screen" class="fade-in">
                <div class="container mx-auto px-6 py-16 md:py-24 text-center">
                    <h1 class="text-4xl md:text-6xl font-extrabold font-inter text-gray-900 leading-tight">Il tuo brand ha <span class="gradient-text">potenziale?</span></h1>
                    <div class="mt-10 max-w-3xl mx-auto space-y-4">
                        <div class="shadow-lg rounded-full">
                            <input id="brand-search-input" type="text" placeholder="1. Inserisci il nome del tuo brand..." class="w-full py-4 px-6 rounded-full text-lg border-2 border-transparent focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="grid md:grid-cols-2 gap-4">
                            <div class="shadow-lg rounded-full">
                                <select id="select-classes" multiple placeholder="2. Seleziona le Classi di Nizza..."></select>
                            </div>
                            <div class="shadow-lg rounded-full">
                                <select id="select-countries" multiple placeholder="3. Seleziona i territori..."></select>
                            </div>
                        </div>
                        <div>
                            <button id="start-search-btn" class="w-full md:w-auto btn-gradient text-white font-bold py-4 px-10 rounded-full text-lg shadow-lg hover:shadow-xl transition-shadow">Analizza Ora</button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="results-screen" class="hidden" aria-live="polite">
                <div class="bg-white border-b border-gray-200/80">
                    <div class="container mx-auto px-6 py-4"><h2 class="text-xl font-semibold">Risultati Analisi per: <span id="searched-brand-name" class="font-bold gradient-text"></span></h2></div>
                </div>
                <div class="container mx-auto px-6 py-12">
                    <div class="grid lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-1 bg-white p-6 md:p-8 rounded-2xl shadow-sm border">
                            <h3 class="text-2xl font-bold font-inter text-center">Brand Potential Score™</h3>
                             <div class="relative w-full max-w-[300px] mx-auto h-[150px] md:h-[200px]"> <canvas id="brandScoreChart"></canvas> <div class="absolute inset-0 flex flex-col items-center justify-center font-inter"> <span id="score-value" class="text-5xl font-extrabold text-gray-800"></span> <span class="text-lg font-semibold text-gray-500">/ 100</span> </div> </div>
                            <div class="mt-8 space-y-6"> <div><div class="flex justify-between font-semibold mb-1"><span>Rischio di Confusione</span><span id="pillar2-value" class="font-bold"></span></div><div class="w-full bg-gray-200 rounded-full h-3"><div id="pillar2-bar" class="h-3 rounded-full transition-all duration-500"></div></div></div> </div>
                        </div>
                        <div class="lg:col-span-2 space-y-6">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border"><h4 class="text-xl font-bold font-inter mb-3">Giudizio Sintetico AI</h4><p id="synthetic-judgment" class="text-gray-700 whitespace-pre-line leading-relaxed"></p></div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border"><h4 class="text-xl font-bold font-inter mb-3">Marchi Simili Trovati (Banca Dati EUIPO)</h4><div id="anteriority-results-container"><p class="text-gray-500">I risultati della ricerca di anteriorità appariranno qui...</p></div></div>
                            <div id="error-box" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert"> <p class="font-bold">Errore di comunicazione</p> <p id="error-message"></p> </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
    const AppController = (function() {
        const state = { brandScoreChart: null, tomSelectClasses: null, tomSelectCountries: null };
        const elements = {
            homeScreen: document.getElementById('home-screen'),
            resultsScreen: document.getElementById('results-screen'),
            startSearchBtn: document.getElementById('start-search-btn'),
            brandSearchInput: document.getElementById('brand-search-input'),
            searchedBrandName: document.getElementById('searched-brand-name'),
            loadingOverlay: document.getElementById('loading-overlay'),
            scoreValue: document.getElementById('score-value'),
            brandScoreChartCanvas: document.getElementById('brandScoreChart'),
            pillars: { p2: { value: document.getElementById('pillar2-value'), bar: document.getElementById('pillar2-bar') } },
            anteriorityContainer: document.getElementById('anteriority-results-container'),
            syntheticJudgment: document.getElementById('synthetic-judgment'),
            errorBox: document.getElementById('error-box'),
            errorMessage: document.getElementById('error-message'),
        };

        const api = {
            API_ENDPOINT: '/api/search', 
            async getAnalysis(payload) {
                const response = await fetch(this.API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Risposta non valida o errore interno del server.' }));
                    throw new Error(errorData.message || `Errore di rete: ${response.status}`);
                }
                return await response.json();
            }
        };

        const render = {
            fullResultsPage(brandName, results) {
                elements.homeScreen.classList.add('hidden');
                elements.resultsScreen.classList.remove('hidden');
                elements.searchedBrandName.textContent = brandName;
                
                if (results.error) {
                    this.showError(results.message);
                    this.updateAnteriorityWithError();
                    elements.syntheticJudgment.textContent = 'Impossibile generare il giudizio a causa di un errore nella ricerca.';
                    this.updateMetrics([]);
                } else {
                    this.hideError();
                    this.updateAnteriorityResults(results.similarMarks);
                    this.updateSyntheticJudgment(results.syntheticJudgment);
                    this.updateMetrics(results.similarMarks);
                }
            },
            updateAnteriorityResults(similarMarks) {
                elements.anteriorityContainer.innerHTML = ''; 
                if (!similarMarks || similarMarks.length === 0) {
                    elements.anteriorityContainer.innerHTML = `<p class="text-green-700 font-semibold">🎉 Ottima notizia! Nessun marchio simile trovato nella banca dati EUIPO.</p>`;
                    return;
                }
                let html = `<p class="text-gray-600 mb-4">Trovati <span class="font-bold">${similarMarks.length} marchi registrati</span> con potenziale di conflitto:</p><div class="space-y-3 max-h-[40rem] overflow-y-auto pr-2">`;
                similarMarks.forEach(mark => {
                    html += `<div class="p-4 border rounded-lg bg-gray-50/50"><div class="flex justify-between items-start gap-4"><div class="flex-grow"><p class="font-bold text-lg">${mark.name}</p><p class="text-sm text-gray-500 mt-1">Titolare: ${mark.owner}</p></div><span class="font-semibold text-xs text-right whitespace-nowrap px-2 py-1 rounded-full bg-gray-200">${mark.status}</span></div><div class="mt-2 pt-2 border-t border-gray-200 flex justify-between text-sm text-gray-600"><span>Classi di Nizza: <b>${mark.classes}</b></span><span>N°: ${mark.applicationNumber}</span></div></div>`;
                });
                html += `</div>`;
                elements.anteriorityContainer.innerHTML = html;
            },
            updateSyntheticJudgment(judgment) {
                elements.syntheticJudgment.textContent = judgment || "Non è stato possibile generare un giudizio sintetico.";
            },
            updateMetrics(similarMarks = []) {
                const riskScore = 100 - (similarMarks.length * 8);
                const score = Math.max(10, riskScore);
                const update = (pillarId, value, labels) => {
                    let label = value > 75 ? labels[0] : (value > 40 ? labels[1] : labels[2]);
                    let color = ui.getScoreColor(value);
                    elements.pillars[pillarId].value.textContent = `${value}% (${label})`;
                    elements.pillars[pillarId].bar.style.width = `${value}%`;
                    elements.pillars[pillarId].bar.style.backgroundColor = color;
                };
                update('p2', score, ['Basso', 'Medio', 'Alto']);
                this.createOrUpdateChart(score);
            },
            createOrUpdateChart(score) {
                const scoreColor = ui.getScoreColor(score);
                elements.scoreValue.textContent = score;
                elements.scoreValue.style.color = scoreColor;
                const data = { datasets: [{ data: [score, 100 - score], backgroundColor: [scoreColor, '#E5E7EB'], borderWidth: 0, circumference: 180, rotation: 270 }] };
                const options = { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { tooltip: { enabled: false } }, events: [] };
                if (state.brandScoreChart) state.brandScoreChart.destroy();
                state.brandScoreChart = new Chart(elements.brandScoreChartCanvas, { type: 'doughnut', data, options });
            },
            showError(message) {
                elements.errorMessage.textContent = `Dettaglio: ${message}`;
                elements.errorBox.classList.remove('hidden');
            },
            hideError() { elements.errorBox.classList.add('hidden'); }
        };

        const ui = {
            showLoading() { elements.loadingOverlay.classList.remove('hidden'); },
            hideLoading() { elements.loadingOverlay.classList.add('hidden'); },
            getScoreColor: score => score < 40 ? 'var(--color-red)' : (score < 75 ? 'var(--color-yellow)' : 'var(--color-green)'),
            async handleSearch() {
                const brandName = elements.brandSearchInput.value.trim();
                const selectedClasses = state.tomSelectClasses.getValue();
                const selectedCountries = state.tomSelectCountries.getValue();

                if (!brandName) { alert('Per favore, inserisci un nome per il brand.'); return; }
                if (selectedClasses.length === 0) { alert('Per favore, seleziona almeno una Classe di Nizza.'); return; }
                if (selectedCountries.length === 0) { alert('Per favore, seleziona almeno un territorio di registrazione.'); return; }
                
                const payload = { brandName, selectedClasses, selectedCountries };
                
                ui.showLoading();
                try {
                    const results = await api.getAnalysis(payload);
                    render.fullResultsPage(brandName, results);
                } catch (error) {
                    render.fullResultsPage(brandName, { error: true, message: error.message });
                } finally {
                    ui.hideLoading();
                }
            },
        };

        function setupTomSelect() {
            // Dati per le Classi di Nizza (1-45)
            const niceClassesOptions = Array.from({length: 45}, (_, i) => ({ value: i + 1, text: `Classe ${i + 1}` }));
            
            // Dati per i Paesi/Regioni
            const countryOptions = [
                {value: 'IT', text: 'Italia'}, {value: 'EU', text: 'Unione Europea'}, {value: 'DE', text: 'Germania'},
                {value: 'FR', text: 'Francia'}, {value: 'ES', text: 'Spagna'}, {value: 'UK', text: 'Regno Unito'},
                {value: 'US', text: 'Stati Uniti'}, {value: 'CN', text: 'Cina'}, {value: 'JP', text: 'Giappone'},
                {value: 'WIPO', text: 'Internazionale (WIPO)'}
            ];

            state.tomSelectClasses = new TomSelect('#select-classes', {
                plugins: ['remove_button'],
                options: niceClassesOptions,
                maxItems: 10
            });
            state.tomSelectCountries = new TomSelect('#select-countries', {
                plugins: ['remove_button'],
                options: countryOptions,
                maxItems: 5
            });
        }

        function init() {
            elements.loadingOverlay.classList.add('hidden');
            setupTomSelect();
            elements.startSearchBtn.addEventListener('click', ui.handleSearch);
        }
        
        return { init };
    })();

    document.addEventListener('DOMContentLoaded', AppController.init);
    </script>
</body>
</html>
```

### 2. Il Backend con "Cervello" AI: `api/search.js`

Questo backend è stato potenziato enormemente. Ora non solo chiama l'EUIPO, ma usa i risultati per costruire un prompt dettagliato e lo invia all'API di Gemini per ottenere il suo giudizio di confondibilità.


```javascript
// Questo file deve trovarsi in: /api/search.js
// Aggiunge la logica per chiamare Gemini e generare un giudizio sintetico.

const fetch = require('node-fetch');

// Funzione per ottenere il token di accesso EUIPO (invariata)
async function getAccessToken(clientId, clientSecret) {
    const tokenUrl = 'https://euipo.europa.eu/cas-server-webapp/oidc/accessToken';
    const basicAuth = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');
    const body = new URLSearchParams();
    body.append('grant_type', 'client_credentials');
    body.append('scope', 'trademark-search.trademarks.read');
    
    const response = await fetch(tokenUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Authorization': `Basic ${basicAuth}` },
        body: body,
    });
    const responseData = await response.json();
    if (!response.ok) throw new Error('Autenticazione EUIPO fallita.');
    return responseData.access_token;
}

// Funzione per cercare marchi su EUIPO (invariata)
async function searchEuipoTrademarks(brandName, accessToken, clientId) {
    const searchApiUrl = `https://api.euipo.europa.eu/trademark-search/trademarks`;
    const rsqlQuery = `wordMarkSpecification.verbalElement==*${brandName}*`;
    const urlWithQuery = `${searchApiUrl}?query=${encodeURIComponent(rsqlQuery)}&size=10`;
    
    const searchResponse = await fetch(urlWithQuery, {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${accessToken}`, 'X-IBM-Client-Id': clientId },
    });
    if (!searchResponse.ok) throw new Error('Ricerca EUIPO fallita.');
    return await searchResponse.json();
}

// Funzione per analizzare i risultati di EUIPO (invariata)
function parseEuipoResponse(jsonResponse) {
    const similarMarks = [];
    const records = jsonResponse?.trademarks || [];
    for (const record of records) {
        similarMarks.push({
            name: record.wordMarkSpecification?.verbalElement || 'N/D',
            owner: record.applicants?.[0]?.name || 'N/D',
            status: record.status || 'N/D',
            classes: `Cl. ${record.niceClasses?.join(', ') || 'N/A'}`,
            applicationNumber: record.applicationNumber,
        });
    }
    return { similarMarks };
}

// *** NUOVA FUNZIONE: GENERAZIONE GIUDIZIO TRAMITE GEMINI ***
async function getSyntheticJudgment(payload, euipoResults) {
    const { brandName, selectedClasses, selectedCountries } = payload;
    const { similarMarks } = euipoResults;

    // Costruiamo un prompt dettagliato per l'AI
    let prompt = `Sei un esperto avvocato specializzato in proprietà intellettuale. Analizza i seguenti dati per fornire un giudizio sintetico (massimo 30 righe, usa un tono professionale e chiaro) sul rischio di confondibilità per un nuovo marchio.

**Dati del Nuovo Marchio:**
- **Nome Proposto:** "${brandName}"
- **Classi di Nizza Selezionate:** ${selectedClasses.join(', ')}
- **Territori di Interesse:** ${selectedCountries.join(', ')}

**Marchi Simili Trovati nella Banca Dati EUIPO:**
`;

    if (similarMarks.length > 0) {
        prompt += similarMarks.map(mark => `- Nome: "${mark.name}", Titolare: ${mark.owner}, Stato: ${mark.status}, Classi: ${mark.classes}`).join('\n');
    } else {
        prompt += "- Nessun marchio simile trovato. Questo è un fattore molto positivo.";
    }

    prompt += `

**Analisi Richiesta:**
Valuta il rischio di confondibilità considerando, in ordine di importanza:
1.  **Somiglianza:** Analizza la somiglianza fonetica e concettuale tra "${brandName}" e i marchi trovati.
2.  **Affinità Merceologica:** Valuta la sovrapposizione tra le classi selezionate (${selectedClasses.join(', ')}) e le classi dei marchi trovati. Se le classi sono identiche o molto affini (es. 3 (cosmetici) e 5 (farmaceutici)), il rischio è molto più alto.
3.  **Sovrapposizione Territoriale:** Considera che i marchi EUIPO coprono tutti i territori dell'Unione Europea. Valuta l'impatto di questo sulla selezione dei territori dell'utente.

Concludi con una valutazione finale del rischio (Basso, Medio, Alto) e un breve consiglio strategico.`;
    
    // Chiamata all'API di Gemini
    const geminiApiKey = process.env.GEMINI_API_KEY; // Chiave API per Gemini, da impostare su Vercel
    if (!geminiApiKey) throw new Error('API Key di Gemini non configurata sul server.');
    
    const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`;
    
    const geminiResponse = await fetch(geminiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });

    if (!geminiResponse.ok) {
        const errorData = await geminiResponse.json();
        console.error("Errore da Gemini:", errorData);
        throw new Error("Il servizio AI non è riuscito a generare un giudizio.");
    }

    const geminiData = await geminiResponse.json();
    return geminiData.candidates[0].content.parts[0].text;
}


// Funzione principale del backend, ora orchestra tutto
module.exports = async (request, response) => {
    response.setHeader('Access-Control-Allow-Origin', '*');
    if (request.method === 'OPTIONS') return response.status(200).end();

    try {
        const payload = request.body;
        if (!payload.brandName) return response.status(400).json({ message: 'Dati mancanti.' });
        
        const { EUIPO_CLIENT_ID, EUIPO_CLIENT_SECRET } = process.env;
        if (!EUIPO_CLIENT_ID || !EUIPO_CLIENT_SECRET) {
            throw new Error('Credenziali EUIPO non configurate.');
        }

        // 1. Chiamata a EUIPO
        const accessToken = await getAccessToken(EUIPO_CLIENT_ID, EUIPO_CLIENT_SECRET);
        const euipoJson = await searchEuipoTrademarks(payload.brandName, accessToken, EUIPO_CLIENT_ID);
        const euipoResults = parseEuipoResponse(euipoJson);

        // 2. Chiamata a Gemini per il giudizio
        const syntheticJudgment = await getSyntheticJudgment(payload, euipoResults);

        // 3. Invio della risposta combinata al frontend
        return response.status(200).json({
            similarMarks: euipoResults.similarMarks,
            syntheticJudgment: syntheticJudgment
        });

    } catch (error) {
        console.error("ERRORE CRITICO nel backend:", error);
        return response.status(500).json({ error: true, message: error.message });
    }
};


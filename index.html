<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Intellimark.ai - Beta con Analisi AI Avanzata</title>
    <!-- Versione 12.0 - UX Semplificata con Classificazione AI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/css/tom-select.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Figtree:wght@400;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary-start: #0A2A5B;
            --color-primary-end: #4A0E69;
            --color-green: #16a34a;
            --color-yellow: #facc15;
            --color-red: #dc2626;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .gradient-text { background: linear-gradient(to right, var(--color-primary-start), var(--color-primary-end)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .btn-gradient { background: linear-gradient(to right, var(--color-primary-start), var(--color-primary-end)); }
        .hidden { display: none !important; }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(248, 250, 252, 0.8); backdrop-filter: blur(5px); z-index: 100; display: flex; align-items: center; justify-content: center; }
        .spinner { border: 6px solid #e2e8f0; border-top: 6px solid var(--color-primary-start); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ts-control { border-radius: 0.5rem !important; border: 1px solid #e5e7eb !important; padding: 0.8rem 1rem !important; }
        .ts-control:focus, .ts-wrapper.focus .ts-control { box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.4) !important; border-color: #3b82f6 !important; }
        .ts-control > .item { background-color: var(--color-primary-start) !important; color: white !important; border-radius: 0.25rem !important; }
        .result-card { background-color: white; border-radius: 0.75rem; border: 1px solid #e5e7eb; padding: 1.5rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.05); }
    </style>
</head>
<body class="antialiased text-slate-700">
    <div id="loading-overlay" class="hidden"> <div class="text-center"> <div class="spinner mx-auto"></div> <p class="mt-4 text-lg font-semibold text-slate-800">Analisi AI in corso...</p> </div> </div>
    <div id="app-container">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-40 border-b border-slate-200/80">
            <div class="container mx-auto px-6 py-4 flex justify-between items-center">
                <a href="#" class="font-inter font-bold text-2xl gradient-text" onclick="location.reload(); return false;" aria-label="Homepage di Intellimark.ai"> Intellimark.ai </a>
            </div>
        </header>
        <main>
            <section id="home-screen" class="fade-in">
                <div class="container mx-auto px-6 py-16 md:py-24 text-center">
                    <h1 class="text-4xl md:text-6xl font-extrabold text-slate-900 leading-tight">Il tuo brand ha <span class="gradient-text">potenziale?</span></h1>
                    <p class="mt-4 max-w-2xl mx-auto text-lg text-slate-600">Ottieni un'analisi strategica basata sui dati ufficiali e sul giudizio della nostra AI.</p>
                    <div class="mt-10 max-w-3xl mx-auto space-y-4 text-left">
                        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                            <label for="brand-search-input" class="block text-sm font-semibold text-slate-700 mb-2">1. Inserisci il nome del brand</label>
                            <input id="brand-search-input" type="text" placeholder="Es. Intellimark" class="w-full p-3 rounded-md text-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                             <label for="product-description" class="block text-sm font-semibold text-slate-700 mb-2">2. Descrivi i prodotti o servizi da registrare</label>
                             <textarea id="product-description" rows="3" placeholder="Es. abbigliamento, scarpe, borse in pelle, servizi di pulizia per uffici..." class="w-full p-3 rounded-md text-lg border border-slate-300 focus:outline-none focus:ring-2 focus:ring-blue-500"></textarea>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-md border border-slate-200">
                            <label for="select-countries" class="block text-sm font-semibold text-slate-700 mb-2">3. Seleziona i territori di registrazione</label>
                            <select id="select-countries" multiple></select>
                        </div>
                        <div class="text-center pt-4">
                            <button id="start-search-btn" class="w-full md:w-auto btn-gradient text-white font-bold py-4 px-10 rounded-full text-lg shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">Analizza Ora</button>
                        </div>
                    </div>
                </div>
            </section>
            <section id="results-screen" class="hidden" aria-live="polite">
                <div class="bg-white border-b border-slate-200/80">
                    <div class="container mx-auto px-6 py-4"><h2 class="text-xl font-semibold text-slate-800">Risultati Analisi per: <span id="searched-brand-name" class="font-bold gradient-text"></span></h2></div>
                </div>
                <div class="container mx-auto px-6 py-12">
                    <div class="grid lg:grid-cols-12 gap-8">
                        <div class="lg:col-span-4">
                            <div class="result-card text-center sticky top-24">
                                <h3 class="text-xl font-bold text-slate-800">Brand Risk Score™</h3>
                                <p class="text-sm text-slate-500 mb-4">Un punteggio basso indica un rischio minore</p>
                                <div class="relative w-full max-w-[250px] mx-auto h-[125px]"> <canvas id="brandScoreChart"></canvas> <div class="absolute inset-0 flex flex-col items-center justify-center font-inter"> <span id="score-value" class="text-5xl font-extrabold text-slate-800"></span> <span class="text-lg font-semibold text-slate-500">/ 100</span> </div> </div>
                                <div id="ai-classes-container" class="mt-6 text-left"></div>
                            </div>
                        </div>
                        <div class="lg:col-span-8 space-y-6">
                            <div class="result-card"><h4 class="text-xl font-bold text-slate-800 mb-3">Giudizio Sintetico AI</h4><p id="synthetic-judgment" class="text-slate-700 whitespace-pre-line leading-relaxed"></p></div>
                            <div class="result-card"><h4 class="text-xl font-bold text-slate-800 mb-3">Marchi Simili Trovati (Banca Dati EUIPO)</h4><div id="anteriority-results-container"><p class="text-slate-500">I risultati della ricerca di anteriorità appariranno qui...</p></div></div>
                            <div id="error-box" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg" role="alert"> <p class="font-bold">Errore di comunicazione</p> <p id="error-message"></p> </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
    const AppController = (function() {
        const state = { brandScoreChart: null, tomSelectCountries: null };
        const elements = {
            homeScreen: document.getElementById('home-screen'),
            resultsScreen: document.getElementById('results-screen'),
            startSearchBtn: document.getElementById('start-search-btn'),
            brandSearchInput: document.getElementById('brand-search-input'),
            productDescription: document.getElementById('product-description'),
            searchedBrandName: document.getElementById('searched-brand-name'),
            loadingOverlay: document.getElementById('loading-overlay'),
            scoreValue: document.getElementById('score-value'),
            brandScoreChartCanvas: document.getElementById('brandScoreChart'),
            anteriorityContainer: document.getElementById('anteriority-results-container'),
            syntheticJudgment: document.getElementById('synthetic-judgment'),
            aiClassesContainer: document.getElementById('ai-classes-container'),
            errorBox: document.getElementById('error-box'),
            errorMessage: document.getElementById('error-message'),
        };

        const api = {
            API_ENDPOINT: '/api/search', 
            async getAnalysis(payload) {
                const response = await fetch(this.API_ENDPOINT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: 'Risposta non valida o errore interno del server.' }));
                    throw new Error(errorData.message || `Errore di rete: ${response.status}`);
                }
                return await response.json();
            }
        };

        const render = {
            fullResultsPage(brandName, results) {
                elements.homeScreen.classList.add('hidden');
                elements.resultsScreen.classList.remove('hidden');
                elements.searchedBrandName.textContent = brandName;
                
                if (results.error) {
                    this.showError(results.message);
                    elements.syntheticJudgment.textContent = 'Impossibile generare il giudizio a causa di un errore.';
                    this.updateAnteriorityWithError();
                    this.updateMetrics([]);
                } else {
                    this.hideError();
                    this.updateAnteriorityResults(results.similarMarks);
                    this.updateSyntheticJudgment(results.syntheticJudgment);
                    this.updateAiIdentifiedClasses(results.identifiedClasses);
                    this.updateMetrics(results.similarMarks);
                }
            },
            updateAnteriorityResults(similarMarks) {
                const container = elements.anteriorityContainer;
                container.innerHTML = ''; 
                if (!similarMarks || similarMarks.length === 0) {
                    container.innerHTML = `<div class="text-center p-6 bg-green-50 border border-green-200 rounded-lg"><p class="font-semibold text-green-800">🎉 Ottima notizia!</p><p class="text-green-700">Nessun marchio simile trovato nelle banche dati per le classi identificate.</p></div>`;
                    return;
                }
                let html = `<p class="text-slate-600 mb-4">Trovati <span class="font-bold">${similarMarks.length} marchi registrati</span> con potenziale di conflitto:</p><div class="space-y-4">`;
                similarMarks.forEach(mark => {
                    const statusInfo = this.getStatusInfo(mark.status);
                    html += `<div class="p-4 border border-slate-200 rounded-lg bg-slate-50/50"><div class="flex justify-between items-start gap-4"><div class="flex-grow"><p class="font-bold text-lg text-slate-800">${mark.name}</p><p class="text-sm text-slate-500 mt-1">Titolare: ${mark.owner}</p></div><span class="font-semibold text-xs text-right whitespace-nowrap px-2.5 py-1 rounded-full ${statusInfo.classes}">${statusInfo.text}</span></div><div class="mt-3 pt-3 border-t border-slate-200 flex justify-between text-sm text-slate-600"><span>Classi di Nizza: <b>${mark.classes}</b></span><span>N°: ${mark.applicationNumber}</span></div></div>`;
                });
                html += `</div>`;
                container.innerHTML = html;
            },
            getStatusInfo(status) {
                const s = (status || "").toLowerCase();
                if (s.includes('registered')) return { text: 'REGISTRATO', classes: 'bg-green-100 text-green-800' };
                if (s.includes('refused') || s.includes('expired') || s.includes('cancelled') || s.includes('withdrawn')) return { text: 'NON ATTIVO', classes: 'bg-red-100 text-red-800' };
                return { text: status.toUpperCase(), classes: 'bg-yellow-100 text-yellow-800' };
            },
            updateSyntheticJudgment(judgment) {
                elements.syntheticJudgment.textContent = judgment || "Non è stato possibile generare un giudizio sintetico.";
            },
             updateAiIdentifiedClasses(classes) {
                const container = elements.aiClassesContainer;
                container.innerHTML = '';
                if (!classes || classes.length === 0) {
                    container.innerHTML = `<p class="text-sm text-red-600">L'AI non è riuscita a identificare classi pertinenti dalla tua descrizione.</p>`;
                    return;
                }
                let html = `<h4 class="font-semibold text-slate-800 mb-2">Classi identificate dall'AI:</h4><div class="flex flex-wrap gap-2">`;
                classes.forEach(c => {
                    html += `<span class="bg-blue-100 text-blue-800 text-sm font-medium px-2.5 py-1 rounded-full">Classe ${c}</span>`;
                });
                html += `</div>`;
                container.innerHTML = html;
            },
            updateMetrics(similarMarks = []) {
                const riskScore = 100 - (similarMarks.length * 8);
                const score = Math.max(10, riskScore);
                this.createOrUpdateChart(score);
            },
            createOrUpdateChart(score) {
                const scoreColor = ui.getScoreColor(score, true);
                const chartCanvas = elements.brandScoreChartCanvas;
                if (state.brandScoreChart) state.brandScoreChart.destroy();
                state.brandScoreChart = new Chart(chartCanvas, { type: 'doughnut', data: { datasets: [{ data: [100 - score, score], backgroundColor: [scoreColor, '#e2e8f0'], borderWidth: 0, circumference: 180, rotation: 270 }] }, options: { responsive: true, maintainAspectRatio: false, cutout: '80%', plugins: { tooltip: { enabled: false } } } });
                elements.scoreValue.textContent = 100 - score;
                elements.scoreValue.style.color = scoreColor;
            },
            showError(message) {
                elements.errorMessage.textContent = `Dettaglio: ${message}`;
                elements.errorBox.classList.remove('hidden');
            },
            hideError() { elements.errorBox.classList.add('hidden'); }
        };

        const ui = {
            showLoading() { elements.loadingOverlay.classList.remove('hidden'); },
            hideLoading() { elements.loadingOverlay.classList.add('hidden'); },
            getScoreColor: (score, isRisk = false) => {
                let effectiveScore = isRisk ? 100 - score : score;
                if (effectiveScore < 40) return 'var(--color-red)';
                if (effectiveScore < 75) return 'var(--color-yellow)';
                return 'var(--color-green)';
            },
            async handleSearch() {
                 const brandName = elements.brandSearchInput.value.trim();
                 const productDescription = elements.productDescription.value.trim();
                 const selectedCountries = state.tomSelectCountries.getValue();
                 if (!brandName || !productDescription || selectedCountries.length === 0) {
                     alert('Per favore, compila tutti i campi di ricerca.');
                     return;
                 }
                 ui.showLoading();
                 try {
                     const results = await api.getAnalysis({ brandName, productDescription, selectedCountries });
                     render.fullResultsPage(brandName, results);
                 } catch (error) {
                     render.fullResultsPage(brandName, { error: true, message: error.message });
                 } finally {
                     ui.hideLoading();
                 }
            }
        };
        
        function initializeApp() {
            document.getElementById('loading-overlay').classList.add('hidden');
            const countryOptions = [
                {value: 'IT', text: 'Italia'}, {value: 'EU', text: 'Unione Europea'}, {value: 'DE', text: 'Germania'},
                {value: 'FR', text: 'Francia'}, {value: 'ES', text: 'Spagna'}, {value: 'GB', text: 'Regno Unito'},
                {value: 'US', text: 'Stati Uniti'}, {value: 'CN', text: 'Cina'}, {value: 'JP', text: 'Giappone'},
                {value: 'WO', text: 'Internazionale (WIPO)'}
            ];
            state.tomSelectCountries = new TomSelect('#select-countries', { plugins: ['remove_button'], maxItems: 5, placeholder: "Es. Italia, EU...", options: countryOptions });
            elements.startSearchBtn.addEventListener('click', ui.handleSearch);
        }

        return { init: initializeApp };
    })();

    document.addEventListener('DOMContentLoaded', AppController.init);
    </script>
</body>
</html>
```

### 3. Il Backend Potenziato con AI a due Fasi

Questo backend è il vero motore della nuova funzionalità. È stato profondamente modificato per gestire il flusso di classificazione e giudizio.


```javascript
// File: /api/search.js
// Logica del backend che esegue un'analisi AI a due fasi.

const fetch = require('node-fetch');

// --- DATABASE DELLE CLASSI DI NIZZA (dal suo PDF) ---
const NICE_CLASSES_KNOWLEDGE_BASE = `
Classe 1: Prodotti chimici per industria, scienze, fotografia, agricoltura, orticoltura, silvicoltura; resine artificiali e materie plastiche grezze; composizioni per estinguere incendi; preparati per tempera e saldatura metalli; sostanze per concia; adesivi industriali; compost, concimi.
Classe 2: Pitture, vernici, lacche; prodotti preservanti da ruggine e deterioramento del legno; coloranti, tinte; inchiostri per stampa; resine naturali grezze; metalli in fogli e polvere per pittura e decorazione.
Classe 3: Cosmetici e preparati per toeletta non medicati; dentifrici non medicati; profumeria, oli essenziali; preparati per sbianca e bucato; preparati per pulire, lucidare, sgrassare e abradere.
Classe 4: Oli e grassi industriali, cera; lubrificanti; prodotti per assorbire polvere; combustibili e materie illuminanti; candele e stoppini.
Classe 5: Prodotti farmaceutici, medici e veterinari; preparazioni sanitarie per uso medico; alimenti e sostanze dietetiche per uso medico o veterinario, alimenti per neonati; integratori alimentari; cerotti, materiali per medicazioni; disinfettanti; fungicidi, erbicidi.
Classe 6: Metalli comuni e loro leghe, minerali; materiali metallici per edilizia; costruzioni trasportabili metalliche; cavi e fili non elettrici; chincaglieria metallica; contenitori metallici; casseforti.
Classe 7: Macchine, macchine-utensili, utensili a corrente; motori (eccetto per veicoli terrestri); giunti e organi di trasmissione; strumenti agricoli (non manuali); incubatrici per uova; distributori automatici.
Classe 8: Utensili e strumenti manuali; coltelleria, forchette e cucchiai; armi bianche; rasoi.
Classe 9: Apparecchi e strumenti scientifici, di ricerca, di navigazione, geodetici, fotografici, cinematografici, audiovisivi, ottici, di pesata, di misura, di segnalazione, di salvataggio; software; computer; mute da sub; estintori.
Classe 10: Apparecchi e strumenti chirurgici, medici, dentari e veterinari; membra, occhi e denti artificiali; articoli ortopedici; materiali di sutura; dispositivi per attività sessuali.
Classe 11: Apparecchi per illuminazione, riscaldamento, cottura, refrigerazione, essiccamento, ventilazione, distribuzione d'acqua e impianti sanitari.
Classe 12: Veicoli; apparecchi di locomozione terrestri, aerei o nautici.
Classe 13: Armi da fuoco; munizioni e proiettili; esplosivi; fuochi d'artificio.
Classe 14: Metalli preziosi e loro leghe; gioielleria, pietre preziose; orologeria e strumenti cronometrici.
Classe 15: Strumenti musicali e loro accessori.
Classe 16: Carta e cartone; stampati; articoli per legatoria; fotografie; cartoleria e articoli per ufficio; adesivi; materiale per disegno e artisti; pennelli; materiale per istruzione; fogli e buste in plastica per imballaggio.
Classe 17: Caucciù, gomma, e succedanei; materie plastiche e resine semilavorate; materie per turare, stoppare e isolare; tubi flessibili non metallici.
Classe 18: Cuoio e sue imitazioni; pelli di animali; bagagli, borse, ombrelli; bastoni da passeggio; fruste, selleria; collari e indumenti per animali.
Classe 19: Materiali da costruzione non metallici; tubi rigidi non metallici per costruzione; asfalto, pece, bitume; costruzioni trasportabili non metalliche; monumenti non metallici.
Classe 20: Mobili, specchi, cornici; contenitori non metallici; osso, corno, balena, madreperla; conchiglie; ambra.
Classe 21: Utensili e recipienti per casa e cucina; pentole e vasellame; pettini e spugne; spazzole; materiali per pulizia; vetro grezzo; vetreria, porcellana, maiolica.
Classe 22: Corde, stringhe, reti, tende, vele, sacchi; materiale per imbottitura; materie tessili fibrose grezze.
Classe 23: Fili e filati per uso tessile.
Classe 24: Tessuti e loro succedanei; biancheria da casa; tende in materia tessile o plastica.
Classe 25: Articoli di abbigliamento, scarpe, cappelleria.
Classe 26: Merletti, pizzi, ricami, nastri, lacci; bottoni, ganci, spille, aghi; fiori artificiali; decorazioni per capelli; capelli finti.
Classe 27: Tappeti, zerbini, stuoie, linoleum e altri rivestimenti per pavimenti; tappezzerie non tessili.
Classe 28: Giochi, giocattoli; apparecchi di videogiochi; articoli per ginnastica e sport; decorazioni per alberi di Natale.
Classe 29: Carne, pesce, pollame, selvaggina; estratti di carne; frutta e ortaggi conservati, congelati, essiccati e cotti; gelatine, marmellate; uova; latte e latticini; oli e grassi per alimenti.
Classe 30: Caffè, tè, cacao; riso, pasta; farine e preparati di cereali; pane, pasticceria, dolciumi; cioccolato; gelati; zucchero, miele; lievito; sale, condimenti, spezie; aceto, salse.
Classe 31: Prodotti agricoli, acquacoltura, orticoli e forestali grezzi; granaglie e sementi; frutta e ortaggi freschi, erbe fresche; piante e fiori naturali; animali vivi; alimenti per animali; malto.
Classe 32: Birre; bevande analcoliche; acque minerali e gassose; bevande di frutta e succhi; sciroppi per bevande.
Classe 33: Bevande alcoliche (eccetto le birre); preparati alcolici per bevande.
Classe 34: Tabacco e succedanei; articoli per fumatori; fiammiferi; sigarette elettroniche.
Classe 35: Pubblicità; gestione, organizzazione e amministrazione aziendale; lavori d'ufficio.
Classe 36: Servizi finanziari, monetari e bancari; servizi di assicurazioni; servizi immobiliari.
Classe 37: Servizi di costruzione; servizi di installazione e riparazione; estrazioni minerarie.
Classe 38: Servizi di telecomunicazioni.
Classe 39: Trasporto; imballaggio e deposito di merci; organizzazione di viaggi.
Classe 40: Trattamento di materiali; riciclaggio; purificazione aria e trattamento acqua; servizi di stampa; conservazione alimenti.
Classe 41: Educazione; formazione; divertimento; attività sportive e culturali.
Classe 42: Servizi scientifici e tecnologici, ricerca e progettazione; servizi di analisi e ricerche industriali; progettazione e sviluppo di hardware e software.
Classe 43: Servizi di ristorazione (alimentazione); alloggi temporanei.
Classe 44: Servizi medici; servizi veterinari; cure d'igiene e di bellezza per persone o animali; servizi di agricoltura, acquacoltura, orticoltura, silvicoltura.
Classe 45: Servizi giuridici; servizi di sicurezza; servizi di incontri, social network online; servizi di pompe funebri; babysitting.
`;

// --- FUNZIONI HELPER ---

// Ottiene il token di accesso dall'EUIPO (invariato)
async function getAccessToken(clientId, clientSecret) {
    const tokenUrl = 'https://euipo.europa.eu/cas-server-webapp/oidc/accessToken';
    const basicAuth = Buffer.from(`${clientId}:${clientSecret}`).toString('base64');
    const body = new URLSearchParams({ grant_type: 'client_credentials', scope: 'trademark-search.trademarks.read' });
    const response = await fetch(tokenUrl, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'Authorization': `Basic ${basicAuth}` }, body });
    const data = await response.json();
    if (!response.ok) throw new Error('Autenticazione EUIPO fallita: ' + (data.error_description || 'Errore sconosciuto'));
    return data.access_token;
}

// Cerca marchi su EUIPO usando le classi identificate
async function searchEuipoTrademarks(brandName, classes, accessToken, clientId) {
    const searchApiUrl = `https://api.euipo.europa.eu/trademark-search/trademarks`;
    const rsqlQuery = `wordMarkSpecification.verbalElement==*${brandName}* and niceClasses=in=(${classes.join(',')})`;
    const urlWithQuery = `${searchApiUrl}?query=${encodeURIComponent(rsqlQuery)}&size=10`;
    const response = await fetch(urlWithQuery, { headers: { 'Authorization': `Bearer ${accessToken}`, 'X-IBM-Client-Id': clientId } });
    if (!response.ok) throw new Error('Ricerca EUIPO fallita.');
    return response.json();
}

// Analizza i risultati EUIPO (invariato)
function parseEuipoResponse(jsonResponse) {
    const similarMarks = [];
    const records = jsonResponse?.trademarks || [];
    for (const record of records) {
        similarMarks.push({
            name: record.wordMarkSpecification?.verbalElement || 'N/D',
            owner: record.applicants?.[0]?.name || 'N/D',
            status: record.status || 'N/D',
            classes: `Cl. ${record.niceClasses?.join(', ') || 'N/A'}`,
            applicationNumber: record.applicationNumber,
        });
    }
    return { similarMarks };
}

// Funzione generica per chiamare l'API di Gemini
async function callGeminiAPI(prompt) {
    const geminiApiKey = "AIzaSyBcRHmCYBvw_9Ya4b3Q0jLWNyD9fwyhvwI";
    const geminiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${geminiApiKey}`;

    const response = await fetch(geminiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
    });

    if (!response.ok) {
        const errorData = await response.json();
        console.error("Errore da Gemini:", errorData);
        throw new Error("Il servizio AI non è riuscito a rispondere.");
    }

    const data = await response.json();
    return data.candidates[0].content.parts[0].text;
}


// --- FLUSSO PRINCIPALE DEL BACKEND ---
module.exports = async (request, response) => {
    response.setHeader('Access-Control-Allow-Origin', '*');
    if (request.method === 'OPTIONS') return response.status(200).end();

    try {
        const payload = request.body;
        if (!payload.brandName || !payload.productDescription) {
            return response.status(400).json({ message: 'Dati mancanti.' });
        }
        
        const { EUIPO_CLIENT_ID, EUIPO_CLIENT_SECRET } = process.env;
        if (!EUIPO_CLIENT_ID || !EUIPO_CLIENT_SECRET) {
            throw new Error('Credenziali EUIPO non configurate.');
        }

        // FASE 1: Classificazione AI dei prodotti/servizi
        const classificationPrompt = `Sei un esperto di Classificazione di Nizza. Analizza la seguente descrizione di prodotti e servizi fornita da un utente e restituisci SOLO un elenco di numeri di classe pertinenti, separati da virgole, senza alcun testo aggiuntivo. Usa la seguente base di conoscenza per la tua analisi:\n\n${NICE_CLASSES_KNOWLEDGE_BASE}\n\nDescrizione Utente: "${payload.productDescription}"\n\nClassi pertinenti:`;
        const identifiedClassesString = await callGeminiAPI(classificationPrompt);
        const identifiedClasses = identifiedClassesString.split(',').map(c => parseInt(c.trim())).filter(c => !isNaN(c));

        if (identifiedClasses.length === 0) {
            throw new Error("L'AI non è riuscita a identificare classi pertinenti dalla descrizione fornita.");
        }

        // FASE 2: Ricerca EUIPO basata sulle classi identificate
        const accessToken = await getAccessToken(EUIPO_CLIENT_ID, EUIPO_CLIENT_SECRET);
        const euipoJson = await searchEuipoTrademarks(payload.brandName, identifiedClasses, accessToken, EUIPO_CLIENT_ID);
        const euipoResults = parseEuipoResponse(euipoJson);

        // FASE 3: Giudizio AI basato su tutti i dati raccolti
        let judgmentPrompt = `Sei un esperto avvocato specializzato in proprietà intellettuale. Fornisci un giudizio sintetico (massimo 30 righe, tono professionale e chiaro) sul rischio di confondibilità.

**Dati del Nuovo Marchio:**
- Nome Proposto: "${payload.brandName}"
- Descrizione Utente: "${payload.productDescription}"
- Classi Identificate dall'AI: ${identifiedClasses.join(', ')}
- Territori di Interesse: ${payload.selectedCountries.join(', ')}

**Marchi Simili Trovati:**
`;
        if (euipoResults.similarMarks.length > 0) {
            judgmentPrompt += euipoResults.similarMarks.map(mark => `- Nome: "${mark.name}", Stato: ${mark.status}, Classi: ${mark.classes}`).join('\n');
        } else {
            judgmentPrompt += "- Nessun marchio simile trovato. Questo è un fattore molto positivo.";
        }
        judgmentPrompt += `

**Analisi Richiesta:**
Valuta il rischio di confondibilità considerando somiglianza fonetica/concettuale, affinità merceologica (tra classi identificate e quelle dei marchi trovati) e sovrapposizione territoriale. Concludi con una valutazione finale del rischio (Basso, Moderato, Medio, Alto) e un consiglio strategico.`;
        const syntheticJudgment = await callGeminiAPI(judgmentPrompt);

        // FASE 4: Invio della risposta combinata
        return response.status(200).json({
            similarMarks: euipoResults.similarMarks,
            syntheticJudgment: syntheticJudgment,
            identifiedClasses: identifiedClasses
        });

    } catch (error) {
        console.error("ERRORE CRITICO nel backend:", error);
        return response.status(500).json({ error: true, message: error.message });
    }
};
